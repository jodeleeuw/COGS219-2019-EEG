---
title: "R Notebook"
output: html_notebook
---

```{r message=FALSE, warning=FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(ez)
library(tidyr)
```


# Subject Exclusions

We are removing subjects who do not have at least 50% good segments.

```{r message=FALSE, warning=FALSE}
subject.segment.log <- read_csv('data/tidy/eeg-segment-count.csv')
good.subjects <- subject.segment.log %>%
  filter(P >= 0.8) %>%
  pull(Subject)
```

# Behavioral Data

Loading in the data and filtering to only good subjects.

```{r message=FALSE, warning=FALSE}
all.behavioral.data <- read_csv('data/tidy/behavioral-data-tidy.csv', progress = FALSE) %>%
  filter(participant_id %in% good.subjects)
```

Graph

```{r echo=FALSE, message=FALSE, warning=FALSE}
subject.level <- all.behavioral.data %>% 
  filter(phase == 'test', target_lag %in% c(2,8)) %>%
  mutate(correct = as.numeric((correct == 'true'))) %>%
  group_by(participant_id, distractor_type, target_lag) %>%
  summarize(accuracy = mean(correct))

summary.data <- subject.level %>%
  group_by(distractor_type, target_lag) %>%
  summarize(M=mean(accuracy), SD=sd(accuracy), SE=sd(accuracy)/sqrt(n()))

ggplot(summary.data, aes(x=target_lag, y=M, color=distractor_type, group=distractor_type))+
  geom_line(size=1)+
  geom_point(size=2)+
  geom_errorbar(aes(ymin=M-SE, ymax=M+SE), size=1,width=0.2)+
  theme_bw()+
  theme(panel.grid=element_blank())
```

ANOVA

```{r echo=FALSE, message=FALSE, warning=FALSE}
behavioral.anova <- ezANOVA(subject.level, dv=accuracy, wid=participant_id, within=c(target_lag, distractor_type))
behavioral.anova$ANOVA
```

# EEG Data

We start by loading in the tidy EEG data. See the `generate-tidy-eeg-data.R` file for the pre-processing steps that produced this file.

```{r message=FALSE, warning=FALSE}
# use progress=FALSE because progress bar seems to slow down read_csv in R notebooks.
eeg.data <- read_csv('data/tidy/eeg-data-tidy.csv', progress= FALSE) %>%
  filter(subject %in% good.subjects)
```

## N2

### Distractor Pictures

Kennedy et al. start by isolating the N2 in response to the distractor images by subtracting the lag 8 baseline from the negative and neutral lag 8 conditions.

We calculate the difference wave at each electrode for each subject in each condition.

```{r}
n2.distractor.data <- eeg.data %>%
  filter(lag.condition == "Lag8", electrode %in% c(64,68,69,89,94,95)) %>%
  mutate(hemisphere = if_else(electrode > 70, "right","left")) %>%
  select(-lag.condition)

n2.distractor.baseline.data <- n2.distractor.data %>% 
  filter(distractor.condition == "Baseline") %>%
  mutate(baseline.voltage = voltage) %>%
  select(-voltage, -distractor.condition)

n2.distractor.difference.waves <- n2.distractor.data %>%
  left_join(n2.distractor.baseline.data, by=c("subject", "t", "electrode", "hemisphere")) %>%
  mutate(difference.wave = voltage - baseline.voltage) %>%
  select(-voltage, -baseline.voltage) %>%
  filter(distractor.condition != "Baseline")
```

A two-factor ANOVA (hemisphere x distractor type) in the time window 185-275ms, on peak negative amplitude. (First average over hemisphere, then find peak)

```{r echo=FALSE, message=FALSE, warning=FALSE}
n2.distractor.anova.data <- n2.distractor.difference.waves %>%
  filter(t %in% 185:275) %>%
  group_by(subject, hemisphere, distractor.condition, t) %>%
  summarize(M = mean(difference.wave)) %>%
  group_by(subject, hemisphere, distractor.condition) %>%
  summarize(peak = min(M))

n2.distractor.anova <- ezANOVA(n2.distractor.anova.data, wid=subject, dv=peak, within=c(hemisphere, distractor.condition))

n2.distractor.anova$ANOVA
```

Follow up t-tests.

First we have to collapse over hemisphere. Note that we take the MIN rather than average when collapsing over hemisphere since we are looking for peak negative amplitude.
(Code is shown here to provide a model for performing t-tests.

```{r}
n2.distractor.t.test.data <- n2.distractor.anova.data %>%
  group_by(subject, distractor.condition) %>%
  summarize(peak = min(peak))
```

Is negative less than neutral?

```{r}
t.test(peak ~ distractor.condition, data=n2.distractor.t.test.data, alternative="less")
```


Follow up one-sample, one-tailed t-tests to see if N2s are less than 0.

Negative condition:

```{r}
# the pull() command extracts the column from the data frame.
n2.distractor.t.test.data %>%
  filter(distractor.condition == "Negative") %>%
  pull(peak) %>%
  t.test(mu=0, alternative="less")
```

Neutral condition:

```{r}
n2.distractor.t.test.data %>%
  filter(distractor.condition == "Neutral") %>%
  pull(peak) %>%
  t.test(mu=0, alternative="less")
```

Basic plotting of the ERPs. (You should make a better plot than this!)
This is analogous to Figure 3.


```{r echo=FALSE, warning=FALSE}
n2.distractor.erp <- n2.distractor.difference.waves %>%
  group_by(distractor.condition, t) %>%
  summarize(M = mean(difference.wave))

ggplot(n2.distractor.erp, aes(x=t, y=M, color=distractor.condition))+
  geom_line()+
  geom_vline(xintercept = 0)+
  scale_y_reverse()+
  scale_x_continuous(limits = c(-200,1000), expand=c(0,0))+
  annotate("rect", xmin=185,xmax=275,ymin=-1,ymax=2.5, alpha=0.2)+
  theme_bw()
```

*Note that it is weird that the average waveforms in the target window are positive, but the t-tests for peak negative amplitude in this window are significantly below 0! Why might that happen, and what does it potentially say about peak negative amplitude as a way of establishing whether there is a significantly below 0 effect?*

### Target Pictures

We need to subtract each lag 8 condition from the corresponding lag 2, which isolates the appearance of the target.

```{r}
n2.target.data <- eeg.data %>%
  filter(electrode %in% c(64,68,69,89,94,95)) %>%
  mutate(hemisphere = if_else(electrode > 70, "right","left"))

n2.target.difference.waves <- n2.target.data %>%
  spread(lag.condition, voltage) %>%
  mutate(difference.wave = Lag2 - Lag8) %>%
  select(-Lag2, -Lag8)
```

ANOVA on **mean** difference (Kennedy et al. are not clear about whether this should be peak or mean...) in the time window 405-585ms after distractor.

```{r echo=FALSE, message=FALSE, warning=FALSE}
n2.target.anova.data <- n2.target.difference.waves %>%
  filter(t %in% 405:585) %>%
  group_by(subject, hemisphere, distractor.condition) %>%
  summarize(M=mean(difference.wave))

n2.target.anova <- ezANOVA(n2.target.anova.data, wid=subject, dv=M, within=c(hemisphere, distractor.condition))
n2.target.anova$ANOVA
  
```


Post-hoc tests

```{r echo=FALSE}
n2.target.t.test.data <- n2.target.anova.data %>%
  group_by(subject, distractor.condition) %>%
  summarize(M=mean(M))
```

Baseline vs. Negative. Is Baseline LESS than Negative, one-tailed?
```{r echo=FALSE}
t.test(M ~ distractor.condition, 
       data = (n2.target.t.test.data %>% filter(distractor.condition != "Neutral")),
       paired = TRUE,
       alternative="less")
```

Baseline vs. Neutral. Is Baseline LESS than Neural, one tailed?
```{r echo=FALSE}
t.test(M ~ distractor.condition, 
       data = (n2.target.t.test.data %>% filter(distractor.condition != "Negative")),
       paired = TRUE,
       alternative="less")
```

Negative vs. Neutral. Is Neutral LESS than Negative, one tailed?

```{r echo=FALSE}
t.test(M ~ distractor.condition, 
       data = (n2.target.t.test.data %>% filter(distractor.condition != "Baseline")),
       paired = TRUE,
       alternative="greater")
```


Basic plot (Figure 4)

```{r echo=FALSE, warning=FALSE}
n2.target.plotting.data <- n2.target.difference.waves %>% 
  group_by(distractor.condition, t) %>%
  summarize(M=mean(difference.wave))

ggplot(n2.target.plotting.data,  aes(x=t, y=M, color=distractor.condition))+
  geom_line()+
  geom_vline(xintercept=0)+
  geom_vline(xintercept=200)+
  scale_y_reverse()+
  scale_x_continuous(limits = c(-200,800), expand=c(0,0))+
  annotate("rect", xmin=405,xmax=585,ymin=-3.5,ymax=1, alpha=0.2)+
  theme_bw()
```

## P3b

### Target Pictures

Subtract Lag 8 from Lag 2 for each condition. Target electrodes: 54, 55, 79, 78, 61, 62. Time window: 635-995.

```{r}
p3b.target.data <- eeg.data %>%
  filter(electrode %in% c(54,55,79,78,61,62))

p3b.target.difference.waves <- p3b.target.data %>%
  spread(lag.condition, voltage) %>%
  mutate(difference.wave = Lag2 - Lag8) %>%
  select(-Lag2, -Lag8) %>%
  group_by(subject, t, distractor.condition) %>%
  summarize(M.difference.wave = mean(difference.wave))
```

ANOVA

```{r echo=FALSE, message=FALSE, warning=FALSE}
p3b.target.anova.data <- p3b.target.difference.waves %>%
  filter(t %in% 635:995) %>%
  group_by(subject, distractor.condition) %>%
  summarize(M = mean(M.difference.wave))

p3b.target.anova <- ezANOVA(p3b.target.anova.data, wid=subject, dv=M, within=c(distractor.condition))
p3b.target.anova$ANOVA
```

Post-hoc tests

Is Baseline GREATER than Neutral?

```{r echo=FALSE}
t.test(M ~ distractor.condition, 
       data = (p3b.target.anova.data %>% filter(distractor.condition != "Negative")),
       paired = TRUE,
       alternative="greater")
```

Is Baseline GREATER than Negative?

```{r echo=FALSE}
t.test(M ~ distractor.condition, 
       data = (p3b.target.anova.data %>% filter(distractor.condition != "Neutral")),
       paired = TRUE,
       alternative="greater")
```

Is Neutral GREATER than Negative?

```{r echo=FALSE}
t.test(M ~ distractor.condition, 
       data = (p3b.target.anova.data %>% filter(distractor.condition != "Baseline")),
       paired = TRUE,
       alternative="less")
```

Plot (Figure 5)

```{r echo=FALSE}

p3b.target.plot.data <- p3b.target.difference.waves %>%
  group_by(t, distractor.condition) %>%
  summarize(M = mean(M.difference.wave))

ggplot(p3b.target.plot.data, aes(x=t,y=M, color=distractor.condition))+
  geom_line()+
  scale_y_reverse()+
  scale_x_continuous(limits = c(-200,1200), expand=c(0,0))+
  annotate("rect", xmin=635,xmax=995,ymin=-4,ymax=5, alpha=0.2)+
  theme_bw()
```

### Distractor Pictures

Subtract Lag 8 Baseline from Lag 8 Neg and Neu. Time window: 400-550ms.
Then merge in lag 2 baseline - lag 8 baseline. *Note that this means the baseline condition is looking at something different than the other conditions.*

```{r}
p3b.distractor.data <- eeg.data %>%
  filter(electrode %in% c(54,55,79,78,61,62)) %>%
  filter(lag.condition == "Lag8") %>%
  select(-lag.condition)

p3b.distractor.baseline <- p3b.distractor.data %>%
  filter(distractor.condition == "Baseline") %>%
  mutate(baseline.voltage = voltage) %>%
  select(-voltage, -distractor.condition)
  
# need to merge in lag 2 baseline - lag 8 baseline
p3b.distractor.baseline.difference <- eeg.data %>%
  filter(electrode %in% c(54,55,79,78,61,62)) %>%
  filter(distractor.condition == "Baseline") %>%
  spread(lag.condition, voltage) %>%
  mutate(difference.wave = Lag2 - Lag8) %>%
  select(-Lag2, -Lag8)

p3b.distractor.difference.waves <- p3b.distractor.data %>%
  inner_join(p3b.distractor.baseline, by=c("subject", "t", "electrode")) %>%
  filter(distractor.condition != "Baseline") %>%
  mutate(difference.wave = voltage - baseline.voltage) %>%
  select(-baseline.voltage, -voltage) %>%
  rbind(p3b.distractor.baseline.difference)

```

ANOVA

```{r echo=FALSE, message=FALSE, warning=FALSE}
p3b.distractor.anova.data <- p3b.distractor.difference.waves %>%
  filter(t %in% 400:550) %>%
  group_by(subject, distractor.condition) %>%
  summarize(M=mean(difference.wave))

p3b.distractor.anova <- ezANOVA(p3b.distractor.anova.data, wid=subject, dv=M, within=distractor.condition)
p3b.distractor.anova$ANOVA
```

Post-hoc tests

Is Baseline GREATER than Neutral?

```{r echo=FALSE}
t.test(M ~ distractor.condition, 
       data = (p3b.distractor.anova.data %>% filter(distractor.condition != "Negative")),
       paired = TRUE,
       alternative="greater")
```

Is Baseline GREATER than Negative?

```{r echo=FALSE}
t.test(M ~ distractor.condition, 
       data = (p3b.distractor.anova.data %>% filter(distractor.condition != "Neutral")),
       paired = TRUE,
       alternative="greater")
```

Is Neutral GREATER than Negative?

```{r echo=FALSE}
t.test(M ~ distractor.condition, 
       data = (p3b.distractor.anova.data %>% filter(distractor.condition != "Baseline")),
       paired = TRUE,
       alternative="less")
```

Plot (Figure 6)

```{r echo=FALSE, warning=FALSE}
p3b.distractor.plot.data <- p3b.distractor.difference.waves %>%
  group_by(distractor.condition, t) %>%
  summarize(M=mean(difference.wave))

ggplot(p3b.distractor.plot.data, aes(x=t, y=M, color=distractor.condition))+
  geom_line()+
  scale_y_reverse()+
  scale_x_continuous(limits = c(-200,1000), expand=c(0,0))+
  annotate("rect", xmin=400,xmax=550,ymin=-2,ymax=3, alpha=0.2)+
  theme_bw()
```

## Posterior Positivity

Remove lag 8 baseline from lag 8 neutral and negative, as in the N2 analysis. But the electrodes are different here: 64, 68, 69, 96, 100, 101.
Critical time window: 405-615ms.

```{r}
pp.data <- eeg.data %>%
  filter(lag.condition == "Lag8", electrode %in% c(64,68,69,96,100,101)) %>%
  mutate(hemisphere = if_else(electrode > 70, "right","left")) %>%
  select(-lag.condition)

pp.baseline.data <- pp.data %>% 
  filter(distractor.condition == "Baseline") %>%
  mutate(baseline.voltage = voltage) %>%
  select(-voltage, -distractor.condition)

pp.difference.waves <- pp.data %>%
  left_join(pp.baseline.data, by=c("subject", "t", "electrode", "hemisphere")) %>%
  mutate(difference.wave = voltage - baseline.voltage) %>%
  select(-voltage, -baseline.voltage) %>%
  filter(distractor.condition != "Baseline")
```

ANOVA

```{r echo=FALSE, message=FALSE, warning=FALSE}
pp.data.anova <- pp.difference.waves %>%
  filter(t %in% 405:615) %>%
  group_by(subject, distractor.condition, hemisphere) %>%
  summarize(M = mean(difference.wave))

pp.anova <- ezANOVA(pp.data.anova, wid=subject, dv=M, within=c(hemisphere, distractor.condition))
pp.anova$ANOVA
```

Post-hoc comparisons

```{r echo=FALSE}
pp.data.t.test <- pp.data.anova %>%
  group_by(subject, distractor.condition) %>%
  summarize(M= mean(M))
```


Plot (Figure 7)

```{r echo=FALSE, warning=FALSE}
pp.data.plot <- pp.difference.waves %>%
  group_by(t, distractor.condition) %>%
  summarize(M = mean(difference.wave))

ggplot(pp.data.plot, aes(x=t, y=M, color=distractor.condition))+
  geom_line()+
  scale_y_reverse()+
  scale_x_continuous(limits = c(-200,800), expand=c(0,0))+
  annotate("rect", xmin=405,xmax=615,ymin=-1,ymax=2, alpha=0.2)+
  theme_bw()
  
```

## Correct vs. Incorrect

Load the segmented data for correct v. incorrect. Only looking at Lag 2 negative distractor condition, because that's where most errors are!

```{r message=FALSE, warning=FALSE}
eeg.data.correct.incorrect <- read_csv('data/tidy/eeg-data-correct-incorrect-tidy.csv', progress=FALSE) %>% 
  filter(subject %in% good.subjects)
```

### Distractor N2 and Posterior Positivity

Finding difference wave (correct trials - incorrect trials)

```{r}
# NOTE: Kennedy et al. are ambiguous about which electrodes are the correct set here. They state that it is the same as the prior electrode set, but used slightly different electrode sets for the N2 and PP analyses. The list of electrodes may need to change.

n2.pp.correct.incorrect <- eeg.data.correct.incorrect %>%
  filter(electrode %in% c(64,68,69,89,94,95))

n2.pp.correct.incorrect.difference.wave <- n2.pp.correct.incorrect %>%
  spread(correct.condition, voltage) %>%
  mutate(difference.wave = Correct - Incorrect) %>%
  select(-Correct, -Incorrect)
```

Time window 250-350ms for N2. One sample t-test: Is difference wave significantly greater than 0?

```{r echo=FALSE}
n2.pp.correct.incorrect.difference.wave %>%
  filter(t %in% 250:350) %>%
  group_by(subject) %>%
  summarize(M = mean(difference.wave)) %>%
  pull(M) %>%
  t.test(mu=0, alternative = "greater")
```

Time window 410-650ms for posterior positivity. Is difference wave significantly less than 0?

```{r echo=FALSE}
n2.pp.correct.incorrect.difference.wave %>%
  filter(t %in% 410:650) %>%
  group_by(subject) %>%
  summarize(M = mean(difference.wave)) %>%
  pull(M) %>%
  t.test(mu=0, alternative = "less")
```

Plot

*Quick Note: Kennedy et al.'s plot of the difference curve is inverted for some reason (i.e., positive values are plotted as negative values) so even though our pattern looks like the opposite, it is actually in the same direction.*

```{r echo=FALSE, warning=FALSE}
n2.pp.correct.incorrect.plot.data <- n2.pp.correct.incorrect %>%
  group_by(correct.condition, t) %>%
  summarize(M = mean(voltage))

n2.pp.correct.incorrect.difference.wave.plot.data <- n2.pp.correct.incorrect.difference.wave %>%
  group_by(t) %>%
  summarize(M = mean(difference.wave))

ggplot(n2.pp.correct.incorrect.plot.data, aes(x=t,y=M,color=correct.condition))+
  geom_line()+
  geom_line(data=n2.pp.correct.incorrect.difference.wave.plot.data, aes(color=NA))+
  scale_y_reverse()+
  scale_x_continuous(limits = c(-200,800), expand=c(0,0))+
  annotate("rect", xmin=250,xmax=350,ymin=-8,ymax=2, alpha=0.2)+
  annotate("rect", xmin=410,xmax=650,ymin=-8,ymax=2, alpha=0.2)+
  theme_bw()
```

### Distractor and Target P3b

Finding difference wave (correct trials - incorrect trials)

```{r}
p3b.correct.incorrect <- eeg.data.correct.incorrect %>%
  filter(electrode %in% c(54,55,79,78,61,62))

p3b.correct.incorrect.difference.wave <- p3b.correct.incorrect %>%
  spread(correct.condition, voltage) %>%
  mutate(difference.wave = Correct - Incorrect) %>%
  select(-Correct, -Incorrect)
```

Time window 400-550ms. Is difference wave significantly less than 0?

```{r echo=FALSE}
p3b.correct.incorrect.difference.wave %>%
  filter(t %in% 400:550) %>%
  group_by(subject) %>%
  summarize(M = mean(difference.wave)) %>%
  pull(M) %>%
  t.test(mu=0, alternative = "less")
```

Time window 635-995ms. Is difference wave significantly greater than 0?

```{r echo=FALSE}
p3b.correct.incorrect.difference.wave %>%
  filter(t %in% 635:995) %>%
  group_by(subject) %>%
  summarize(M = mean(difference.wave)) %>%
  pull(M) %>%
  t.test(mu=0, alternative = "greater")
```

Plot

```{r echo=FALSE}
p3b.correct.incorrect.plot.data <- p3b.correct.incorrect %>%
  group_by(correct.condition, t) %>%
  summarize(M = mean(voltage))

p3b.correct.incorrect.difference.wave.plot.data <- p3b.correct.incorrect.difference.wave %>%
  group_by(t) %>%
  summarize(M = mean(difference.wave))

ggplot(p3b.correct.incorrect.plot.data, aes(x=t,y=M,color=correct.condition))+
  geom_line()+
  geom_line(data=p3b.correct.incorrect.difference.wave.plot.data, aes(color=NA))+
  scale_y_reverse()+
  scale_x_continuous(limits = c(-200,1200), expand=c(0,0))+
  annotate("rect", xmin=400,xmax=550,ymin=-2,ymax=4, alpha=0.2)+
  annotate("rect", xmin=635,xmax=995,ymin=-2,ymax=4, alpha=0.2)+
  theme_bw()
```
