---
title: "R Notebook"
output: html_notebook
---

```{r message=FALSE, warning=FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(ez)
library(tidyr)
```

# Behavioral Data

# EEG Data

We start by loading in the tidy EEG data. See the `generate-tidy-eeg-data.R` file for the pre-processing steps that produced this file.

```{r message=FALSE, warning=FALSE, include=FALSE}
# use progress=FALSE because progress bar seems to slow down read_csv in R notebooks.
eeg.data <- read_csv('data/tidy/eeg-data-tidy.csv', progress= FALSE)
```

## N2

### Distractor Pictures

Kennedy et al. start by isolating the N2 in response to the distractor images by subtracting the lag 8 baseline from the negative and neutral lag 8 conditions.

We calculate the difference wave at each electrode for each subject in each condition.

```{r}
n2.distractor.data <- eeg.data %>%
  filter(lag.condition == "Lag8", electrode %in% c(64,68,69,89,94,95)) %>%
  mutate(hemisphere = if_else(electrode > 70, "right","left")) %>%
  select(-lag.condition)

n2.distractor.baseline.data <- n2.distractor.data %>% 
  filter(distractor.condition == "Baseline") %>%
  mutate(baseline.voltage = voltage) %>%
  select(-voltage, -distractor.condition)

n2.distractor.difference.waves <- n2.distractor.data %>%
  left_join(n2.distractor.baseline.data, by=c("subject", "t", "electrode", "hemisphere")) %>%
  mutate(difference.wave = voltage - baseline.voltage) %>%
  select(-voltage, -baseline.voltage) %>%
  filter(distractor.condition != "Baseline")
```

A two-factor ANOVA (hemisphere x distractor type) in the time window 185-275ms, on peak negative amplitude. (First average over hemisphere, then find peak)

```{r echo=FALSE, message=FALSE, warning=FALSE}
n2.distractor.anova.data <- n2.distractor.difference.waves %>%
  filter(t %in% 185:275) %>%
  group_by(subject, hemisphere, distractor.condition, t) %>%
  summarize(M = mean(difference.wave)) %>%
  group_by(subject, hemisphere, distractor.condition) %>%
  summarize(peak = min(M))

n2.distractor.anova <- ezANOVA(n2.distractor.anova.data, wid=subject, dv=peak, within=c(hemisphere, distractor.condition))

n2.distractor.anova$ANOVA
```

Follow up t-tests.

First we have to collapse over hemisphere. Note that we take the MIN rather than average when collapsing over hemisphere since we are looking for peak negative amplitude.

```{r}
n2.distractor.t.test.data <- n2.distractor.anova.data %>%
  group_by(subject, distractor.condition) %>%
  summarize(peak = min(peak))
```

Is negative less than neutral?

```{r}
t.test(peak ~ distractor.condition, data=n2.distractor.t.test.data, alternative=c("less"))
```


Follow up one-sample, one-tailed t-tests to see if N2s are less than 0.

Negative condition:

```{r}
n2.distractor.t.test.data %>%
  filter(distractor.condition == "Negative") %>%
  pull(peak) %>%
  t.test(mu=0, alternative="less")
```

Neutral condition:

```{r}
n2.distractor.t.test.data %>%
  filter(distractor.condition == "Neutral") %>%
  pull(peak) %>%
  t.test(mu=0, alternative="less")
```

Basic plotting of the ERPs. (You should make a better plot than this!)

```{r echo=FALSE}
n2.distractor.erp <- n2.distractor.difference.waves %>%
  group_by(distractor.condition, t) %>%
  summarize(M = mean(difference.wave))

ggplot(n2.distractor.erp, aes(x=t, y=M, color=distractor.condition))+
  geom_line()+
  geom_vline(xintercept = 0)+
  theme_bw()
```

### Target Pictures

We need to subtract each lag 8 condition from the corresponding lag 2, which isolates the appearance of the target.

```{r}
n2.target.data <- eeg.data %>%
  filter(electrode %in% c(64,68,69,89,94,95)) %>%
  mutate(hemisphere = if_else(electrode > 70, "right","left"))

n2.target.difference.waves <- n2.target.data %>%
  spread(lag.condition, voltage) %>%
  mutate(difference.wave = Lag2 - Lag8) %>%
  select(-Lag2, -Lag8)
```

ANOVA
```{r echo=FALSE, message=FALSE, warning=FALSE}
n2.target.anova.data <- n2.target.difference.waves %>%
  filter(t %in% 405:585) %>%
  group_by(subject, hemisphere, distractor.condition) %>%
  summarize(M=mean(difference.wave))

n2.target.anova <- ezANOVA(n2.target.anova.data, wid=subject, dv=M, within=c(hemisphere, distractor.condition))
n2.target.anova$ANOVA
  
```

Basic plot

```{r echo=FALSE}
n2.target.plotting.data <- n2.target.difference.waves %>% 
  group_by(distractor.condition, t) %>%
  summarize(M=mean(difference.wave))

ggplot(n2.target.plotting.data,  aes(x=t, y=M, color=distractor.condition))+
  geom_line()+
  geom_vline(xintercept=0)+
  geom_vline(xintercept=200)+
  theme_bw()
```

## P3b

### Target Pictures

Subtract Lag 8 from Lag 2 for each condition. Target electrodes: 54, 55, 79, 78, 61, 62. Time window: 635-995.

```{r}
p3b.target.data <- eeg.data %>%
  filter(electrode %in% c(54,55,79,78,61,62))

p3b.target.difference.waves <- p3b.target.data %>%
  spread(lag.condition, voltage) %>%
  mutate(difference.wave = Lag2 - Lag8) %>%
  select(-Lag2, -Lag8) %>%
  group_by(subject, t, distractor.condition) %>%
  summarize(M.difference.wave = mean(difference.wave))
```

ANOVA

```{r echo=FALSE, message=FALSE, warning=FALSE}
p3b.target.anova.data <- p3b.target.difference.waves %>%
  filter(t %in% 635:995) %>%
  group_by(subject, distractor.condition) %>%
  summarize(M = mean(M.difference.wave))

p3b.target.anova <- ezANOVA(p3b.target.anova.data, wid=subject, dv=M, within=c(distractor.condition))
p3b.target.anova$ANOVA
```

Plot

```{r echo=FALSE}

p3b.target.plot.data <- p3b.target.difference.waves %>%
  group_by(t, distractor.condition) %>%
  summarize(M = mean(M.difference.wave))

ggplot(p3b.target.plot.data, aes(x=t,y=M, color=distractor.condition))+
  geom_line()
```

### Distractor Pictures

Subtract Lag 8 Baseline from Lag 8 Neg and Neu. Time window: 400-550ms.

```{r}
p3b.distractor.data <- eeg.data %>%
  filter(electrode %in% c(54,55,79,78,61,62)) %>%
  filter(lag.condition == "Lag8") %>%
  select(-lag.condition)

p3b.distractor.baseline <- p3b.distractor.data %>%
  filter(distractor.condition == "Baseline") %>%
  mutate(baseline.voltage = voltage) %>%
  select(-voltage, -distractor.condition)
  
# need to merge in lag 2 baseline - lag 8 baseline
p3b.distractor.baseline.difference <- eeg.data %>%
  filter(electrode %in% c(54,55,79,78,61,62)) %>%
  filter(distractor.condition == "Baseline") %>%
  spread(lag.condition, voltage) %>%
  mutate(difference.wave = Lag2 - Lag8) %>%
  select(-Lag2, -Lag8)

p3b.distractor.difference.waves <- p3b.distractor.data %>%
  inner_join(p3b.distractor.baseline, by=c("subject", "t", "electrode")) %>%
  filter(distractor.condition != "Baseline") %>%
  mutate(difference.wave = voltage - baseline.voltage) %>%
  select(-baseline.voltage, -voltage) %>%
  rbind(p3b.distractor.baseline.difference)

```

ANOVA

```{r echo=FALSE, message=FALSE, warning=FALSE}
p3b.distractor.anova.data <- p3b.distractor.difference.waves %>%
  filter(t %in% 400:550) %>%
  group_by(subject, distractor.condition) %>%
  summarize(M=mean(difference.wave))

p3b.distractor.anova <- ezANOVA(p3b.distractor.anova.data, wid=subject, dv=M, within=distractor.condition)
p3b.distractor.anova$ANOVA
```


Plot
```{r echo=FALSE}
p3b.distractor.plot.data <- p3b.distractor.difference.waves %>%
  group_by(distractor.condition, t) %>%
  summarize(M=mean(difference.wave))

ggplot(p3b.distractor.plot.data, aes(x=t, y=M, color=distractor.condition))+
  geom_line()
```

## Posterior Positivity

Remove lag 8 baseline from lag 8 neutral and negative, as in the N2 analysis. But the electrodes are different here: 64, 68, 69, 96, 100, 101.
Critical time window: 405-615ms.

```{r}
pp.data <- eeg.data %>%
  filter(lag.condition == "Lag8", electrode %in% c(64,68,69,96,100,101)) %>%
  mutate(hemisphere = if_else(electrode > 70, "right","left")) %>%
  select(-lag.condition)

pp.baseline.data <- pp.data %>% 
  filter(distractor.condition == "Baseline") %>%
  mutate(baseline.voltage = voltage) %>%
  select(-voltage, -distractor.condition)

pp.difference.waves <- pp.data %>%
  left_join(pp.baseline.data, by=c("subject", "t", "electrode", "hemisphere")) %>%
  mutate(difference.wave = voltage - baseline.voltage) %>%
  select(-voltage, -baseline.voltage) %>%
  filter(distractor.condition != "Baseline")
```

ANOVA

```{r echo=FALSE, message=FALSE, warning=FALSE}
pp.data.anova <- pp.difference.waves %>%
  filter(t %in% 405:615) %>%
  group_by(subject, distractor.condition, hemisphere) %>%
  summarize(M = mean(difference.wave))

pp.anova <- ezANOVA(pp.data.anova, wid=subject, dv=M, within=c(hemisphere, distractor.condition))
pp.anova$ANOVA
```

Plot

```{r echo=FALSE}
pp.data.plot <- pp.difference.waves %>%
  group_by(t, distractor.condition) %>%
  summarize(M = mean(difference.wave))

ggplot(pp.data.plot, aes(x=t, y=M, color=distractor.condition))+
  geom_line()
```